name: Create Deploy Key

on:
  workflow_dispatch:
  # schedule:
  #   # Runs at 05:00 UTC every day '0 5 * * *'
  #   - cron: '0 0/1 * * *'
permissions:
  id-token: write
  # contents: read # set required permissions (https://docs.github.com/en/actions/using-jobs/assigning-permissions-to-jobs)
  
jobs:
  create-deploy-key:
    runs-on: ubuntu-latest
    steps:
      # Step 1: Generate SSH Key
      - name: Generate SSH Key
        run: |
          ssh-keygen -t rsa -b 4096 -N '' -f gh-deploy-key
          echo "SSH_PRIVATE_KEY<<EOF" >> $GITHUB_ENV
          cat gh-deploy-key >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          
      # Just for demonstration - print Public Key
      # - name: Display Public Key
      #   run: |
      #     cat gh-deploy-key.pub

      # Add public key as a deploy key to the repository using GitHub App token to the repo example-with-autogenerated-deploy-key
      # secrets.APP_INSTALLATION_TOKEN is generated by the generate_github_app_install_token.py
      - name: Add Deploy Key to Repository
        env:
          GITHUB_APP_TOKEN: ${{secrets.APP_INSTALLATION_TOKEN}}
        run: |
          DEPLOY_KEY=$(cat gh-deploy-key.pub)
          CURRENT_DATE=$(date +"%Y-%m-%d %H:%M:%S")
          curl \
            -X POST \
            -H "Authorization: Bearer ${GITHUB_APP_TOKEN}" \
            -H "Accept: application/vnd.github+json" \
            https://api.github.com/repos/satr/example-with-autogenerated-deploy-key/keys \
            -d "{\"title\":\"Automated Deploy Key - ${CURRENT_DATE}\",\"key\":\"${DEPLOY_KEY}\",\"read_only\":true}"

      # Optional - save deploy key to a Azure Key vault
      - name: 'Az CLI login'
        uses: azure/login@v1
        with:
          client-id: 012345678-a263-45ea-6541-abcde123456789 #app registration Application ID or user-assigned managed identity Client ID
          tenant-id: 87564321-bbbb-aaaa-9999-987654321098
          allow-no-subscriptions: true
      - name: 'Get Azure principal token'
        run: |
          token=$(az account get-access-token --resource 6dae42f8-4368-4678-94ff-3960e28e3630 --query=accessToken -otsv)
          echo "::add-mask::$token"
          echo "SERVICE_ACCOUNT_TOKEN=$token" >> $GITHUB_ENV
          #TODO add $DEPLOY_KEY to Azure Key vault with deploy keys, secret deploy-key-app-name

      # Security: Handle the private key securely
      - name: Clean up environment
        if: always()
        run: |
          echo "Cleaning up private key..."
          echo "SSH_PRIVATE_KEY=" >> $GITHUB_ENV
